set -x
set -e

mkdir inst/tmp

cd inst/tmp/

Rscript -e 'download.file("https://github.com/opencv/opencv/archive/master.zip", "opencv-master.zip")'
Rscript -e 'unzip("opencv-master.zip")'

cp ../6810.patch opencv-master/cmake/6810.patch
cd opencv-master/cmake/
patch < 6810.patch
rm -rf 6810.patch
cd ../..

cd opencv-master
mkdir build
cd build

cmake -DWITH_IPP=ON -DINSTALL_CREATE_DISTRIB=ON -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_INSTALL_PREFIX=${R_PACKAGE_DIR}/opencv/ ../
make -j4
make install

cd ../../..

rm -rf tmp
