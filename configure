set -x
set -e

mkdir inst/tmp
mkdir inst/opencv/

cd inst/tmp/

Rscript -e 'download.file("https://github.com/Itseez/opencv/archive/3.1.0.zip", "opencv_3.1.0.zip")'
Rscript -e 'unzip("opencv_3.1.0.zip")'

# if [[ $R_PLATFORM == *"apple"* ]]
# then
  mv ../OpenCVModule.patch opencv-3.1.0/cmake/OpenCVModule.patch
  cd opencv-3.1.0/cmake/
  patch < OpenCVModule.patch
  rm -rf OpenCVModule.patch
  cd ../..
# fi

cd opencv-3.1.0
mkdir build
cd build

cmake -D R_PACKAGE_DIR=${R_PACKAGE_DIR} -D WITH_IPP=ON -D INSTALL_CREATE_DISTRIB=ON -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=../../../opencv/ ../
make -j4
make install

cd ../../..

rm -rf tmp
